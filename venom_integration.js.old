const venom = require('venom-bot');
const express = require('express');
const axios = require('axios');

const app = express();
app.use(express.json());

const WEBHOOK_URL = 'http://localhost:5000/api/webhook/message';

console.log('‚öôÔ∏è Iniciando VenomBot...');
console.log(`üì° Webhook configurado para: ${WEBHOOK_URL}\n`);

venom
  .create({
    session: 'veloce-crm',
    headless: false,
    useChrome: true,
    logQR: true,
    browserArgs: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage',
      '--disable-accelerated-2d-canvas',
      '--no-first-run',
      '--no-zygote',
      '--disable-gpu'
    ]
  })
  .then((client) => {
    console.log('‚úÖ VenomBot inicializado com sucesso!');
    console.log('üéØ VenomBot aguardando mensagens...\n');

    // ============================
    // RECEBER MENSAGENS
    // ============================
    client.onMessage(async (message) => {
      try {
        // Ignora mensagens enviadas pela pr√≥pria empresa
        if (message.fromMe) {
          console.log('‚è≠Ô∏è  Ignorando mensagem pr√≥pria');
          return;
        }

        console.log('\nüì® ===== NOVA MENSAGEM RECEBIDA =====');
        console.log(`üë§ De: ${message.from}`);
        console.log(`üìõ Nome: ${message.notifyName || message.pushName || 'Sem nome'}`);
        console.log(`üí¨ Conte√∫do: ${message.body}`);
        console.log(`üïê Hor√°rio: ${new Date().toLocaleString('pt-BR')}`);
        console.log(`üì± Tipo: ${message.type}`);

        const payload = {
          from: message.from,
          body: message.body,
          notifyName: message.notifyName || message.pushName || 'Lead',
          timestamp: message.timestamp,
          fromMe: message.fromMe,
          type: message.type
        };

        console.log('\nüì§ Enviando para o CRM...');
        console.log('üîó URL:', WEBHOOK_URL);
        console.log('üì¶ Payload:', JSON.stringify(payload, null, 2));

        // Enviar para o webhook do Flask
        const response = await axios.post(WEBHOOK_URL, payload, {
          headers: { 'Content-Type': 'application/json' },
          timeout: 10000
        });

        console.log('\n‚úÖ SUCESSO! Resposta do CRM:');
        console.log('   Status:', response.status);
        console.log('   Data:', JSON.stringify(response.data, null, 2));
        console.log('=====================================\n');

      } catch (error) {
        console.error('\n‚ùå ===== ERRO AO ENVIAR PARA CRM =====');
        
        if (error.code === 'ECONNREFUSED') {
          console.error('üî¥ CONEX√ÉO RECUSADA!');
          console.error(`   O Flask est√° rodando em ${WEBHOOK_URL}?`);
          console.error('   Verifique se o backend est√° online!');
        } else if (error.code === 'ETIMEDOUT') {
          console.error('‚è±Ô∏è  TIMEOUT! O Flask n√£o respondeu em 10 segundos');
        } else if (error.response) {
          console.error('üìõ Resposta de erro do Flask:');
          console.error('   Status:', error.response.status);
          console.error('   Data:', JSON.stringify(error.response.data, null, 2));
        } else {
          console.error('üí• Erro desconhecido:', error.message);
          console.error('   Stack:', error.stack);
        }
        
        console.error('=====================================\n');
      }
    });

    // ============================
    // API PARA ENVIAR MENSAGENS
    // ============================
    app.post('/send', async (req, res) => {
      try {
        const { phone, message } = req.body;

        console.log(`\nüì§ ===== ENVIANDO MENSAGEM =====`);
        console.log(`üì± Para: ${phone}`);
        console.log(`üí¨ Mensagem: ${message}`);

        // Formatar n√∫mero
        const phoneFormatted = phone.includes('@c.us') ? phone : `${phone}@c.us`;

        await client.sendText(phoneFormatted, message);

        console.log(`‚úÖ Mensagem enviada com sucesso!`);
        console.log(`================================\n`);

        res.json({ success: true });

      } catch (error) {
        console.error('\n‚ùå ===== ERRO AO ENVIAR MENSAGEM =====');
        console.error('üí• Erro:', error.message);
        console.error('======================================\n');

        res.status(500).json({ 
          success: false, 
          error: error.message 
        });
      }
    });

    // ============================
    // STATUS DA CONEX√ÉO
    // ============================
    app.get('/status', async (req, res) => {
      try {
        const hostDevice = await client.getHostDevice();
        
        res.json({
          connected: true,
          phone: hostDevice?.id?.user || 'N√∫mero n√£o dispon√≠vel',
          session: 'veloce-crm',
          timestamp: new Date().toISOString()
        });
      } catch (error) {
        res.json({
          connected: true,
          phone: 'N√£o dispon√≠vel',
          session: 'veloce-crm',
          timestamp: new Date().toISOString(),
          warning: 'N√£o foi poss√≠vel obter informa√ß√µes do dispositivo'
        });
      }
    });

    // ============================
    // HEALTH CHECK
    // ============================
    app.get('/health', (req, res) => {
      res.json({ 
        status: 'ok',
        service: 'venom-bot',
        uptime: process.uptime(),
        timestamp: new Date().toISOString()
      });
    });

    // ============================
    // INICIAR SERVIDOR
    // ============================
    app.listen(3001, () => {
      console.log('\nüöÄ Servidor Venom rodando em http://localhost:3001');
      console.log('   POST /send - Enviar mensagem');
      console.log('   GET /status - Status da conex√£o');
      console.log('   GET /health - Health check');
      console.log('   Webhook CRM: ' + WEBHOOK_URL);
      console.log('');
    });

  })
  .catch((error) => {
    console.error('‚ùå Erro ao inicializar VenomBot:', error);
    process.exit(1);
  });